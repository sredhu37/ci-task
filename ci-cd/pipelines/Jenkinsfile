commitHash = ""
pythonImage = null

node() {
    timeout(20) {
        init()
        test()
    }
}

def init() {
    stage('init') {
        checkout scm

        def commitInfo = (sh (label: 'Get commit info', returnStdout: true, script: 'git log -n 1 --format="%H;%T;%an;%ae;%s"')).trim().split(';')
        commitHash = commitInfo[0]

        sh "printenv"
        echo "commitHash: ${commitHash}"

        echo "Building python runtime image..."
        dir("ci-cd/images/python-runtime") {
            pythonImage = docker.build("python-runtime:${env.BRANCH_NAME}${commitHash}")
        }
    }
}

def test() {
    stage('test') {
        pythonImage.inside {
            sh '''
                pwd
                ls -al
                pytest
            '''
        }
    }
}